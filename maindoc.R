#libs
library(tidyverse)
library(serial)
library(stringi)

#funcs
#???????, ??????????? ?????????? ?????? (?????) ?????? ?? ?????????????? ?????
splitter <- function(x) {
  output <- strsplit(x, split = " ")
  return(output)
}

#?????????, ??????????? ?????? ? ????
saver <- function(dataframe_output, stopTime, path) {
  stopTime_str <- str_replace_all(stopTime, ":", " ")
  write.csv2(dataframe_output, 
             file = paste0(path, paste0("output_for_",
                                        str_replace_all(stopTime, ":", " "), 
                                        ".csv")))  
}

#main

#?????? ???????????? ??????? ????? ??? ?????????? ??????,
#? ????? ?????????? ????? COM-?????
path <- paste0(choose.dir(caption = "???????? ?????????? 
                          ??? ?????????? ??????:"), "\\")
gsub(x = path, replacement = "/", pattern = "\\",)
port <- readline(prompt = "??????? ????? ????????????????? ?????, 
                 ? ???????? ????????? ??????, ? ??????? COMXX: ")

#??????????? ???????? ??????? ??? ?????????? ??????
stopTime_interval <- as.numeric(readline(prompt = 
                                           "??????? ???????? ???????, 
                                         ?????? \n??????? ????? ??????????? 
                                         ???? (? ?????, ????? ?????):"))*3600

#????????? ?????????? ? ???????????????? ?????? ? ????????? 
#??? ???????? ????????
ser <- serialConnection(port = port, mode = "19200,n,8,1", buffering = 'line')
is_con_open <- open(ser)

#?????????? ??? ?????? ?????????? ?????? ? ??????????: newText ????????????
#??? ????????? ??????????? ?????? ? ?????? ?????? ???????, ?? newText 
#??????? ?????????? ? foo, ??? ?????????? ????????? ?????? ????????? 
#???????????? ?????????? textSize. ??????? ?????? vec ? mat ???????? 
#??????? ??? ???????????? ?????????? ?????? ? ???????? ?? ??? ???????.

newText <- ""
stopTime <- Sys.time() + stopTime_interval
foo <- list()
textSize <- 0
vec <- vector()
mat <- matrix(nrow = 1, ncol = 10)

#????? ?????????? ???????? ???? ?????????, ?????????? ??????????? ? ?? 
#?????????????? ????????? ??? ?????????? ??????. 
#????? ???? ?????????? ? ?????? ??????.

if (is_con_open == "DONE") {
  while(T) {
    while (Sys.time() < stopTime) {
    if (Sys.time() < stopTime) {
      newText <- read.serialConnection(ser)
      if(0 < nchar(newText))
      {
        foo <- c(foo, paste(newText, Sys.time()))
      }
    } 
    if (Sys.time() >= stopTime) {
      cat("?????? ?????????? ??????. ?? ?????????? ?????? ?????????!")
      
      for (i in c(1:length(foo))) {
        vec <- c(vec, as.vector(foo[[i]]))
        vecSplitted <- splitter(vec)[[1]]
        mat <- rbind(mat, vecSplitted)
      }
      
      dataframed_output <- data.frame(mat)
      saver(dataframed_output, stopTime, path)
      
      stopTime = Sys.time() + stopTime_interval
      cat(paste("?????????? ?", Sys.time(), "?????? ???????"))
      foo <- list()
      mat <- matrix(nrow = 1, ncol = 10)
      vec <- vector()
      break
    } 
  }
}} else cat("??????: COM-???? ?????????? (??? ??????: 1)")
 



